<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enter Access Key - ARAFAT'S TOOLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-start: #f0f2f5;
            --bg-color-end: #d9e0e7;
            --primary-text: #526177;
            --shadow-light: #ffffff;
            --shadow-dark: #b8c1cd;
            --accent-color: #0077ff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-end));
            color: var(--primary-text);
        }
        .soft-ui {
            background: linear-gradient(145deg, var(--bg-color-end), var(--bg-color-start));
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }
        .soft-ui-inset {
            border-radius: 12px;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }
        .btn-primary {
             background: var(--accent-color);
             color: white;
             border-radius: 12px;
             box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
             transition: all 0.2s ease-in-out;
        }
        .btn-primary:active, .btn-primary:disabled {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px);
            opacity: 0.8;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen p-4">

    <div class="soft-ui p-8 md:p-12 w-full max-w-md mx-auto text-center rounded-2xl">
        <h1 class="text-3xl font-bold mb-2">ARAFAT'S TOOLS</h1>
        <p class="mb-6">Please enter your access key to continue.</p>

        <form id="keyForm">
            <input 
                type="text" 
                id="accessKeyInput"
                placeholder="Enter your key..."
                class="w-full p-4 mb-4 text-center bg-transparent soft-ui-inset focus:outline-none text-lg"
                required
            >
            <button 
                type="submit"
                id="submitBtn"
                class="w-full p-4 font-bold btn-primary"
            >
                Unlock Tools
            </button>
        </form>
        <p id="errorMessage" class="text-red-500 mt-4 h-5 font-semibold"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD7PthBfFrmQX6DG21GVji759dp2T73uGo",
          authDomain: "arafattools-11005.firebaseapp.com",
          projectId: "arafattools-11005",
          storageBucket: "arafattools-11005.firebasestorage.app",
          messagingSenderId: "456746063501",
          appId: "1:456746063501:web:498f9590531823dd50f4c4",
          measurementId: "G-QS1VXSKTWD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const keyForm = document.getElementById('keyForm');
        const keyInput = document.getElementById('accessKeyInput');
        const errorMessage = document.getElementById('errorMessage');
        const submitBtn = document.getElementById('submitBtn');

        // FIXED: Replaced crypto.randomUUID() with a compatible method
        const getOrCreateDeviceId = () => {
            let deviceId = localStorage.getItem('uniqueDeviceId');
            if (!deviceId) {
                // This is a reliable fallback that works on any site (http or https)
                const randomPart = Math.random().toString(36).substring(2, 15);
                const timePart = Date.now().toString(36);
                deviceId = `${timePart}-${randomPart}`;
                localStorage.setItem('uniqueDeviceId', deviceId);
            }
            return deviceId;
        };

        const deviceId = getOrCreateDeviceId();

        // Check if user is already logged in
        const loggedInKey = localStorage.getItem('userAccessKey');
        if (loggedInKey) {
            // Optional: You could re-verify the key here, but for simplicity we'll just redirect.
            window.location.href = 'tools.html';
        }

        keyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const key = keyInput.value.trim().toUpperCase();
            if (!key) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Verifying...';
            errorMessage.textContent = '';

            try {
                const keyDocRef = doc(db, 'accessKeys', key);
                const keyDocSnap = await getDoc(keyDocRef);

                // 1. Check if key exists and is valid
                if (!keyDocSnap.exists() || keyDocSnap.data().status !== 'active') {
                    throw new Error('Invalid or inactive key.');
                }
                
                const keyData = keyDocSnap.data();
                const now = new Date();
                
                // 2. Check if key is expired
                if (keyData.expiryDate && keyData.expiryDate.toDate() < now) {
                    throw new Error('This key has expired.');
                }

                // 3. Check device limit
                const deviceLimit = keyData.deviceLimit || 1; // Default to 1 if not set
                const sessionsColRef = collection(db, 'accessKeys', key, 'sessions');
                const sessionsSnapshot = await getDocs(sessionsColRef);
                const activeSessions = sessionsSnapshot.docs;
                const sessionCount = activeSessions.length;

                const isDeviceAlreadyRegistered = activeSessions.some(doc => doc.id === deviceId);

                if (isDeviceAlreadyRegistered) {
                    // This device is already logged in, let them proceed
                    console.log('Device already registered. Logging in.');
                } else if (sessionCount >= deviceLimit) {
                    // Device limit reached, and this is a new device
                    throw new Error(`Device limit (${deviceLimit}) reached.`);
                } else {
                    // There's space, so register this new device
                    console.log('Registering new device session.');
                    const sessionDocRef = doc(db, 'accessKeys', key, 'sessions', deviceId);
                    await setDoc(sessionDocRef, {
                        loggedInAt: serverTimestamp(),
                        userAgent: navigator.userAgent // Store some device info
                    });
                    // Update the session count on the main key document
                    await updateDoc(keyDocRef, {
                        sessionCount: sessionCount + 1,
                        lastLogin: serverTimestamp() // Also update last login time
                    });
                }
                
                // If all checks pass, grant access
                localStorage.setItem('userAccessKey', key);
                window.location.href = 'tools.html';

            } catch (error) {
                console.error("Login Error:", error);
                errorMessage.textContent = error.message || 'An unknown error occurred.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Unlock Tools';
            }
        });
    </script>
</body>
</html>